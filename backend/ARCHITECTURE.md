# AICSL 后端架构

## 概述

AICSL 后端采用模块化单体架构，按照关注点分离原则组织代码结构。系统分为四个主要层次：API层、业务逻辑层、数据访问层和基础设施层。

## 架构层次

```
backend/
├── app/
│   ├── api/          # API 路由层 - 处理 HTTP 请求和响应
│   ├── services/     # 业务逻辑层 - 核心业务逻辑和协调
│   ├── repositories/ # 数据访问层 - 数据模型和数据库操作
│   └── core/         # 基础设施层 - 配置、工具和中间件
```

## 详细结构

### 1. API 层 (`app/api/`)

**职责**: 处理 HTTP 请求路由、参数验证、响应格式化

```
api/
├── v1/                    # API 版本管理
│   ├── auth.py           # 认证相关端点
│   ├── users.py          # 用户管理
│   ├── projects.py       # 项目管理
│   ├── whiteboard.py     # 白板功能
│   ├── documents.py      # 文档管理
│   ├── chat.py           # 聊天功能
│   ├── ai.py             # AI 功能
│   └── ...
└── __init__.py
```

**设计原则**:
- 每个模块对应一个业务领域
- 使用 Pydantic 进行请求/响应验证
- 统一的错误处理和响应格式
- OpenAPI/Swagger 文档自动生成

### 2. 业务逻辑层 (`app/services/`)

**职责**: 实现业务规则、协调多个数据源、处理复杂逻辑

```
services/
├── auth_service.py       # 认证业务逻辑
├── whiteboard_service.py # 白板业务逻辑
├── ai_service.py         # AI 业务逻辑
├── cache_service.py      # 缓存业务逻辑
├── room_mapping_service.py # 房间映射逻辑
└── __init__.py
```

**设计原则**:
- 每个服务处理特定业务领域
- 依赖注入和接口抽象
- 事务管理和数据一致性
- 缓存和性能优化

### 3. 数据访问层 (`app/repositories/`)

**职责**: 数据模型定义、数据库操作、查询优化

```
repositories/
├── user.py              # 用户模型
├── project.py           # 项目模型
├── document.py          # 文档模型
├── whiteboard_snapshot.py # 白板快照模型
├── activity_log.py      # 活动日志模型
└── __init__.py
```

**设计原则**:
- 使用 Beanie ODM 进行 MongoDB 操作
- 模型定义和业务逻辑分离
- 索引优化和查询性能
- 数据验证和约束

### 4. 基础设施层 (`app/core/`)

**职责**: 系统配置、工具函数、中间件、监控

```
core/
├── config.py            # 应用配置
├── db/                  # 数据库连接
│   ├── mongodb.py
│   └── migrations/
├── cache.py             # Redis 缓存
├── security.py          # 安全工具
├── permissions.py       # 权限控制
├── monitoring.py        # 监控和指标
├── error_handlers.py    # 错误处理
├── logging_config.py    # 日志配置
├── schemas/             # Pydantic schemas
├── middleware/          # 中间件
└── utils/               # 工具函数
```

**设计原则**:
- 横切关注点的集中管理
- 可重用的工具和中间件
- 配置外部化和环境管理
- 监控和可观测性

## 通信架构

### 三层通信架构

1. **REST API 层**: 传统 CRUD 操作
   - 端点: `/api/v1/*`
   - 协议: HTTP/HTTPS
   - 用途: 用户管理、项目设置、数据查询

2. **实时协作层**: 高频协作数据同步
   - 端点: `/ysocket/{room_name}`
   - 协议: WebSocket + Y.js
   - 用途: 白板编辑、文档协作

3. **即时通讯层**: 聊天和通知
   - 端点: `/socket.io/`
   - 协议: WebSocket + Socket.IO
   - 用途: 实时聊天、用户状态、通知

### 房间命名规范

```
Socket.IO: project:{project_id}
Y.js 白板: wb:{project_id}
Y.js 文档: doc:{document_id}
```

## 数据流

### 请求处理流程

```
HTTP Request
    ↓
API 路由层 (参数验证)
    ↓
业务逻辑层 (规则处理)
    ↓
数据访问层 (数据库操作)
    ↓
基础设施层 (缓存/日志)
    ↓
HTTP Response
```

### 实时协作流程

```
WebSocket 连接
    ↓
身份验证和权限检查
    ↓
房间管理和状态同步
    ↓
Y.js CRDT 算法
    ↓
数据库持久化 (防抖)
```

## 设计模式

### 依赖注入
- 服务层通过构造函数注入依赖
- 便于测试和模块替换
- 支持接口抽象

### 存储库模式
- 数据访问逻辑封装在 Repository 中
- 业务逻辑与数据访问分离
- 支持不同数据源的切换

### 装饰器模式
- 缓存装饰器 `@cached`
- 性能监控装饰器
- 权限检查装饰器

### 策略模式
- AI 服务支持多种提供商
- 缓存策略可配置
- 存储策略可扩展

## 性能优化

### 缓存策略
- 多级缓存: 内存 → Redis → 数据库
- TTL 设置防止内存泄漏
- 缓存失效策略

### 数据库优化
- 复合索引优化查询
- TTL 索引自动清理过期数据
- 连接池和查询优化

### 异步处理
- 异步数据库操作
- 异步任务队列
- 非阻塞 I/O

## 安全性

### 身份验证
- JWT Token 认证
- 自动 Token 刷新
- 安全 Token 存储

### 权限控制
- 基于角色的访问控制 (RBAC)
- 项目级权限管理
- 细粒度的资源权限

### 数据安全
- 输入验证和清理
- SQL 注入防护
- XSS 防护
- HTTPS 强制

### 基础设施安全
- 非 root 用户运行
- 最小权限原则
- 网络隔离
- 安全头配置

## 监控和可观测性

### 指标收集
- HTTP 请求指标
- 数据库查询性能
- 缓存命中率
- 业务指标

### 日志记录
- 结构化日志
- 不同日志级别
- 分布式追踪支持

### 健康检查
- 应用健康状态
- 依赖服务状态
- 资源使用监控

## 测试策略

### 单元测试
- 业务逻辑单元测试
- 工具函数测试
- 模型验证测试

### 集成测试
- API 端点测试
- 数据库操作测试
- 缓存集成测试

### 端到端测试
- 用户流程测试
- 实时协作测试
- 性能回归测试

## 部署和扩展

### 容器化
- 多阶段 Docker 构建
- 最小镜像大小
- 安全加固

### 扩展策略
- 水平扩展支持
- 服务拆分准备
- 负载均衡配置

### 配置管理
- 环境变量配置
- 密钥管理
- 配置验证

## 总结

这个架构设计提供了：
- **清晰的分层**: 每个层次职责明确
- **高可维护性**: 模块化设计便于修改
- **高可扩展性**: 支持水平和垂直扩展
- **高安全性**: 多层安全防护
- **高可观测性**: 完善的监控和日志
- **高性能**: 缓存和优化策略

架构遵循了 SOLID 原则、DRY 原则和关注点分离原则，为长期维护和功能扩展提供了坚实的基础。


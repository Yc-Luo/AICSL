"""Chat log API routes."""

from typing import List, Optional

from fastapi import APIRouter, Depends, HTTPException, Query, status

from app.api.v1.auth import get_current_user
from app.core.permissions import check_project_permission
from app.repositories.chat_log import ChatLog
from app.repositories.project import Project
from app.repositories.user import User
from app.core.schemas.chat import ChatLogListResponse, ChatLogResponse

router = APIRouter(prefix="/chat", tags=["chat"])


@router.get("/projects/{project_id}/messages", response_model=ChatLogListResponse)
async def get_chat_messages(
    project_id: str,
    skip: int = Query(0, ge=0),
    limit: int = Query(50, ge=1, le=100),
    message_type: Optional[str] = Query(None, pattern="^(text|system|ai)$"),
    current_user: User = Depends(get_current_user),
) -> ChatLogListResponse:
    """Get chat messages for a project with pagination."""
    # Check project access
    project = await Project.get(project_id)
    if not project:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Project not found",
        )

    # Check permission
    if not check_project_permission(
        current_user, project.owner_id, current_user.role
    ):
        is_member = any(
            m.get("user_id") == str(current_user.id) for m in project.members
        )
        if not is_member and current_user.role not in ["admin", "teacher"]:
            raise HTTPException(
                status_code=status.HTTP_403_FORBIDDEN,
                detail="You don't have permission to access this project",
            )

    # Build query
    query = {"project_id": project_id}
    if message_type:
        query["message_type"] = message_type

    # Get messages (most recent first)
    messages_cursor = (
        ChatLog.find(query).skip(skip).limit(limit).sort("-created_at")
    )
    messages_list = await messages_cursor.to_list()
    total = await ChatLog.find(query).count()

    # Get user info for messages
    user_ids = list(set(msg.user_id for msg in messages_list if msg.user_id != "system" and msg.user_id != "ai_assistant"))
    users = {}
    if user_ids:
        import bson
        from app.repositories.user import User

        # Convert string IDs to ObjectIds for lookup
        object_ids = [bson.ObjectId(uid) for uid in user_ids if bson.ObjectId.is_valid(uid)]
        user_list = await User.find({"_id": {"$in": object_ids}}).to_list()
        users = {str(u.id): u for u in user_list}

    return ChatLogListResponse(
        messages=[
            ChatLogResponse(
                id=str(msg.id),
                project_id=msg.project_id,
                user_id=msg.user_id,
                username=users.get(msg.user_id).username if users.get(msg.user_id) else "System",
                avatar_url=users.get(msg.user_id).avatar_url if users.get(msg.user_id) else None,
                content=msg.content,
                message_type=msg.message_type,
                mentions=msg.mentions,
                created_at=msg.created_at,
            )
            for msg in messages_list
        ],
        total=total,
    )

